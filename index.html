<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Math Riddles Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#121212">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #7C4DFF;
      --primary-light: #B388FF;
      --primary-dark: #651FFF;
      --secondary: #00E676;
      --error: #FF5252;
      --bg-dark: #121212;
      --bg-light: #1E1E1E;
      --surface: #252525;
      --text-primary: #FFFFFF;
      --text-secondary: #BDBDBD;
      --font-main: 'Poppins', sans-serif;
      --font-mono: 'Roboto Mono', monospace;
      --key-size: min(20vw, 80px);
      --border-radius: 14px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: var(--bg-dark);
      color: var(--text-primary);
      height: 100%;
      overflow: hidden;
      touch-action: manipulation;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      animation: fadeIn 0.8s ease-out forwards;
      animation-delay: 0.8s;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .screen {
      display: none;
      width: 100%;
      height: 100%;
      max-width: 500px;
      padding: 16px;
      box-sizing: border-box;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: var(--bg-dark);
      position: relative;
      flex-direction: column;
    }

    .active {
      display: flex;
    }

    /* Updated font sizes */
    #homeScreen h1 {
      font-size: clamp(36px, 10vw, 48px);
      color: var(--primary-light);
      text-align: center;
      margin: 12px 0 20px;
      font-weight: 600;
      text-shadow: 0 0 12px rgba(124, 77, 255, 0.4);
    }

    h2 {
      font-size: clamp(20px, 5vw, 24px);
      color: var(--primary-light);
      text-align: center;
      margin: 0 0 16px;
      font-weight: 600;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px;
      font-size: clamp(16px, 4vw, 18px);
      border-radius: var(--border-radius);
      margin: 8px auto;
      display: block;
      width: 100%;
      max-width: 280px;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(124, 77, 255, 0.3);
      transition: var(--transition);
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%, -50%);
      transform-origin: 50% 50%;
    }

    .btn:active::after {
      animation: ripple 0.6s ease-out;
    }

    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(40, 40);
        opacity: 0;
      }
    }

    .btn:hover, .btn:focus {
      background: var(--primary-dark);
      box-shadow: 0 4px 16px rgba(124, 77, 255, 0.4);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn.secondary {
      background: var(--surface);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    .btn.secondary:hover {
      background: #333;
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 16px 0;
      padding: 0 8px;
    }

    .keypad button {
      height: var(--key-size);
      width: 100%;
      font-size: clamp(18px, 5vw, 22px);
      background: var(--surface);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      transition: var(--transition);
      font-family: var(--font-mono);
      font-weight: 500;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    .keypad button:active {
      transform: scale(0.96);
      background: var(--primary-dark);
    }

    .keypad button.operator {
      background: var(--primary);
    }

    .answer-box {
      font-size: clamp(22px, 6vw, 26px);
      color: var(--secondary);
      margin: 12px 8px;
      min-height: 36px;
      text-align: center;
      font-family: var(--font-mono);
      font-weight: 500;
      letter-spacing: 1px;
      text-shadow: 0 0 8px rgba(0, 230, 118, 0.3);
    }

    .result {
      font-size: clamp(14px, 3.8vw, 16px);
      margin: 12px 0;
      min-height: 24px;
      text-align: center;
      padding: 10px;
      border-radius: var(--border-radius);
      background: rgba(0, 230, 118, 0.1);
      color: var(--secondary);
    }

    .result.error {
      background: rgba(255, 82, 82, 0.1);
      color: var(--error);
    }

    .level-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 16px 0;
      padding: 0 8px;
    }

    .level-grid button {
      padding: 12px 0;
      border-radius: 10px;
      background-color: var(--surface);
      color: var(--text-primary);
      border: none;
      font-size: clamp(12px, 2.8vw, 14px);
      transition: var(--transition);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .level-grid button.completed {
      background: var(--primary);
      color: white;
    }

    .level-grid button:active {
      transform: scale(0.96);
    }

    .level-grid button:disabled {
      opacity: 0.5;
      cursor: default;
      background: #333;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 18px 0;
      padding: 12px 14px;
      background: var(--surface);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .toggle-container label {
      font-size: clamp(14px, 3.8vw, 16px);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 26px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #555;
      transition: var(--transition);
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: var(--transition);
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(22px);
    }

    .question-container {
      background: var(--surface);
      padding: 16px;
      border-radius: var(--border-radius);
      margin: 12px 0;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    #questionText {
      font-size: clamp(15px, 4vw, 17px);
      line-height: 1.4;
      text-align: center;
      color: var(--text-primary);
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 1000;
    }

    /* Splash Screen */
    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, var(--bg-dark), #1A1A2E);
      color: var(--primary-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: splashFade 1.5s ease-out forwards;
    }

    .logo {
      font-size: clamp(50px, 18vw, 70px);
      animation: logoAnim 2s ease-in-out infinite;
      margin-bottom: 16px;
      text-shadow: 0 0 16px rgba(124, 77, 255, 0.6);
    }

    .splash-text {
      font-size: clamp(18px, 5vw, 24px);
      font-weight: 600;
      margin-top: 16px;
      opacity: 0;
      animation: textFadeIn 0.8s ease-out forwards;
      animation-delay: 0.4s;
    }

    @keyframes logoAnim {
      0% { transform: scale(1) rotate(0); }
      30% { transform: scale(1.08) rotate(5deg); }
      60% { transform: scale(0.95) rotate(-5deg); }
      100% { transform: scale(1) rotate(0); }
    }

    @keyframes textFadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes splashFade {
      0% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; visibility: hidden; }
    }

    /* Mobile-specific adjustments */
    @media (max-height: 700px) {
      #homeScreen h1 {
        margin: 8px 0 16px;
      }
      
      .btn {
        padding: 12px;
        margin: 6px auto;
      }
      
      .keypad {
        gap: 8px;
        margin: 12px 0;
      }
      
      .keypad button {
        height: calc(var(--key-size) * 0.85);
      }
      
      .question-container {
        padding: 14px;
      }
    }

    @media (max-width: 400px) {
      .screen {
        padding: 12px;
      }
      
      .level-grid {
        gap: 6px;
      }
      
      .toggle-container {
        padding: 10px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash">
    <div class="logo">🧠</div>
    <div class="splash-text">Math Riddles</div>
  </div>

  <!-- Main App Container -->
  <div class="container">
    <!-- Home Screen -->
    <div id="homeScreen" class="screen active">
      <h1>Math Riddles</h1>
      <button class="btn" id="playBtn">▶ Play</button>
      <button class="btn secondary" id="levelsBtn">📚 Levels</button>
      <button class="btn secondary" id="settingsBtn">⚙️ Settings</button>
      <button class="btn secondary" id="quitBtn">❌ Quit</button>
    </div>

    <!-- Settings Screen -->
    <div id="settingsScreen" class="screen">
      <h2>Settings</h2>
      <div class="toggle-container">
        <label for="musicToggle">
          <span>🎵</span> Background Music
        </label>
        <label class="switch">
          <input type="checkbox" id="musicToggle" checked>
          <span class="slider"></span>
        </label>
      </div>
      <div class="toggle-container">
        <label for="sfxToggle">
          <span>🔊</span> Sound Effects
        </label>
        <label class="switch">
          <input type="checkbox" id="sfxToggle" checked>
          <span class="slider"></span>
        </label>
      </div>
      <button class="btn secondary" id="backFromSettingsBtn">⬅ Back</button>
    </div>

    <!-- Levels Screen -->
    <div id="levelsScreen" class="screen">
      <h2>Select Level</h2>
      <div class="level-grid" id="levelButtons"></div>
      <button class="btn secondary" id="backFromLevelsBtn">⬅ Back</button>
    </div>

    <!-- Riddle Screen -->
    <div id="riddleScreen" class="screen">
      <h2 id="levelTitle">Level</h2>
      
      <div class="question-container">
        <div id="questionText"></div>
      </div>
      
      <div class="answer-box" id="answerBox"></div>

      <div class="keypad">
        <button data-number="1">1</button>
        <button data-number="2">2</button>
        <button data-number="3">3</button>
        <button data-number="4">4</button>
        <button data-number="5">5</button>
        <button data-number="6">6</button>
        <button data-number="7">7</button>
        <button data-number="8">8</button>
        <button data-number="9">9</button>
        <button id="clearBtn" class="operator">C</button>
        <button data-number="0">0</button>
        <button id="submitBtn" class="operator">✓</button>
      </div>

      <div class="result" id="resultMsg"></div>

      <div style="display: flex; gap: 8px; justify-content: center; margin: 8px 0;">
        <button class="btn secondary" id="hintBtn" style="flex: 1;">Hint</button>
        <button class="btn secondary" id="solutionBtn" style="flex: 1;">Solution</button>
      </div>
      <button class="btn secondary" id="backFromGameBtn">⬅ Back</button>
    </div>
  </div>

  <canvas id="confetti-canvas"></canvas>
  
  <!-- Audio Elements -->
  <audio id="bgMusic" src="bg-music.mp3" loop></audio>
  <audio id="clickSound" src="click.mp3"></audio>
  <audio id="correctSound" src="correct-answer.mp3"></audio>
  <audio id="wrongSound" src="wrong-answer.mp3"></audio>
  <audio id="levelCompleteSound" src="level-complete.mp3"></audio>
  <audio id="hintSound" src="hint.mp3"></audio>
  <audio id="solutionSound" src="solution.mp3"></audio>
  <audio id="screenTransitionSound" src="transition.mp3"></audio>
  <audio id="buttonHoverSound" src="hover.mp3"></audio>

  <script>
    // Game data
    const riddles = [
      { 
        question: "I am a 2-digit number. When reversed, I become 27 more than my original value. My digits add up to 9. What number am I?", 
        answer: "36", 
        hint: "The reversed number is 63", 
        solution: "63 - 36 = 27, and 3 + 6 = 9" 
      },
      { 
        question: "If you divide 30 by half and then add 10, what do you get?", 
        answer: "70", 
        hint: "Dividing by half is the same as multiplying by 2", 
        solution: "30 ÷ 0.5 = 60, then 60 + 10 = 70" 
      },
      { 
        question: "What is the smallest 3-digit Armstrong number (a number that equals the sum of its own digits each raised to the power of the number of digits)?", 
        answer: "153", 
        hint: "1³ + 5³ + 3³ = ?", 
        solution: "1 + 125 + 27 = 153" 
      },
      { 
        question: "If 1=3, 2=3, 3=5, 4=4, 5=4, then what does 6 equal?", 
        answer: "3", 
        hint: "Count the letters in the English word for each number", 
        solution: "six has 3 letters (s-i-x)" 
      },
      { 
        question: "What comes next in this sequence: 1, 11, 21, 1211, 111221, ...?", 
        answer: "312211", 
        hint: "This is the 'look-and-say' sequence", 
        solution: "1, one 1, two 1s, one 2 one 1, etc." 
      }
    ];
    
    // Generate additional riddles
    while (riddles.length < 50) {
      let n = riddles.length + 1;
      const operations = [
        { op: '+', fn: (a,b) => a + b, word: "plus" },
        { op: '-', fn: (a,b) => a - b, word: "minus" },
        { op: '×', fn: (a,b) => a * b, word: "times" }
      ];
      const selected = operations[Math.floor(Math.random() * operations.length)];
      const a = Math.floor(Math.random() * 15) + 1;
      const b = Math.floor(Math.random() * 15) + 1;
      riddles.push({
        question: `What is ${a} ${selected.op} ${b}?`,
        answer: selected.fn(a,b).toString(),
        hint: `Basic arithmetic operation (${selected.word})`,
        solution: `${a} ${selected.op} ${b} = ${selected.fn(a,b)}`
      });
    }

    // Game state
    let currentLevel = parseInt(localStorage.getItem("currentLevel") || "1");
    let solved = JSON.parse(localStorage.getItem("solvedLevels") || "[]");
    let userAnswer = "";
    let isProcessingInput = false;

    // DOM elements
    const elements = {
      screens: {
        home: document.getElementById("homeScreen"),
        settings: document.getElementById("settingsScreen"),
        levels: document.getElementById("levelsScreen"),
        riddle: document.getElementById("riddleScreen")
      },
      buttons: {
        play: document.getElementById("playBtn"),
        levels: document.getElementById("levelsBtn"),
        settings: document.getElementById("settingsBtn"),
        quit: document.getElementById("quitBtn"),
        backFromSettings: document.getElementById("backFromSettingsBtn"),
        backFromLevels: document.getElementById("backFromLevelsBtn"),
        backFromGame: document.getElementById("backFromGameBtn"),
        clear: document.getElementById("clearBtn"),
        submit: document.getElementById("submitBtn"),
        hint: document.getElementById("hintBtn"),
        solution: document.getElementById("solutionBtn")
      },
      gameElements: {
        levelTitle: document.getElementById("levelTitle"),
        questionText: document.getElementById("questionText"),
        answerBox: document.getElementById("answerBox"),
        resultMsg: document.getElementById("resultMsg"),
        levelButtons: document.getElementById("levelButtons")
      },
      audio: {
        bgMusic: document.getElementById("bgMusic"),
        click: document.getElementById("clickSound"),
        correct: document.getElementById("correctSound"),
        wrong: document.getElementById("wrongSound"),
        levelComplete: document.getElementById("levelCompleteSound"),
        hint: document.getElementById("hintSound"),
        solution: document.getElementById("solutionSound"),
        screenTransition: document.getElementById("screenTransitionSound"),
        buttonHover: document.getElementById("buttonHoverSound")
      },
      toggles: {
        music: document.getElementById("musicToggle"),
        sfx: document.getElementById("sfxToggle")
      },
      splash: document.getElementById("splash"),
      confettiCanvas: document.getElementById("confetti-canvas")
    };

    // Initialize the game
    function initGame() {
      // Set audio volumes
      elements.audio.bgMusic.volume = 0.3;
      elements.audio.click.volume = 0.6;
      elements.audio.correct.volume = 0.5;
      elements.audio.wrong.volume = 0.5;
      elements.audio.levelComplete.volume = 0.6;
      elements.audio.hint.volume = 0.5;
      elements.audio.solution.volume = 0.5;
      elements.audio.screenTransition.volume = 0.4;
      elements.audio.buttonHover.volume = 0.3;

      // Initialize toggle states from localStorage
      if (localStorage.getItem("music") !== "off") {
        elements.toggles.music.checked = true;
        // Auto-start background music
        setTimeout(() => {
          elements.audio.bgMusic.play().catch(e => {
            // If autoplay fails, enable on first interaction
            document.addEventListener('click', () => {
              elements.audio.bgMusic.play().catch(console.error);
            }, { once: true });
          });
        }, 1500);
      } else {
        elements.toggles.music.checked = false;
      }

      if (localStorage.getItem("sfx") !== "off") {
        elements.toggles.sfx.checked = true;
      } else {
        elements.toggles.sfx.checked = false;
      }

      // Set up event listeners
      setupEventListeners();
      
      // Render levels
      renderLevels();

      // Handle splash screen
      setTimeout(() => {
        elements.splash.style.display = "none";
      }, 1500);
    }

    // Set up all event listeners
    function setupEventListeners() {
      // Navigation buttons
      elements.buttons.play.addEventListener("click", startGame);
      elements.buttons.levels.addEventListener("click", () => showScreen("levelsScreen"));
      elements.buttons.settings.addEventListener("click", () => showScreen("settingsScreen"));
      elements.buttons.quit.addEventListener("click", () => {
        if (confirm("Are you sure you want to quit?")) {
          window.close();
        }
      });
      elements.buttons.backFromSettings.addEventListener("click", () => showScreen("homeScreen"));
      elements.buttons.backFromLevels.addEventListener("click", () => showScreen("homeScreen"));
      elements.buttons.backFromGame.addEventListener("click", () => showScreen("homeScreen"));
      
      // Game buttons
      elements.buttons.clear.addEventListener("click", clearAnswer);
      elements.buttons.submit.addEventListener("click", submitAnswer);
      elements.buttons.hint.addEventListener("click", showHint);
      elements.buttons.solution.addEventListener("click", showSolution);
      
      // Keypad buttons - using event delegation
      document.querySelector(".keypad").addEventListener("click", (e) => {
        if (isProcessingInput) return;
        isProcessingInput = true;
        
        const button = e.target.closest("button");
        if (button && button.dataset.number) {
          press(parseInt(button.dataset.number));
        }
        
        setTimeout(() => { isProcessingInput = false; }, 100);
      });
      
      // Touch events for keypad
      document.querySelector(".keypad").addEventListener("touchstart", (e) => {
        if (isProcessingInput) return;
        isProcessingInput = true;
        
        const button = e.target.closest("button");
        if (button) {
          if (button.dataset.number) {
            press(parseInt(button.dataset.number));
          }
          button.classList.add("active");
        }
        
        setTimeout(() => { isProcessingInput = false; }, 100);
      }, { passive: true });
      
      document.querySelector(".keypad").addEventListener("touchend", (e) => {
        const button = e.target.closest("button");
        if (button) {
          button.classList.remove("active");
        }
      }, { passive: true });
      
      // Button hover effects
      document.querySelectorAll(".btn").forEach(btn => {
        btn.addEventListener("mouseenter", () => playSound(elements.audio.buttonHover));
      });
      
      // Toggle switches
      elements.toggles.music.addEventListener("change", toggleMusic);
      elements.toggles.sfx.addEventListener("change", toggleSFX);
      
      // Handle Android back button
      window.addEventListener("popstate", handleBackButton);
    }

    function handleBackButton() {
      if (elements.screens.home.classList.contains("active")) {
        if (confirm("Do you want to exit the game?")) {
          window.close();
        }
      } else {
        showScreen("homeScreen");
      }
    }

    function toggleMusic() {
      if (elements.toggles.music.checked) {
        elements.audio.bgMusic.play().catch(e => console.log("Music play error:", e));
        localStorage.setItem("music", "on");
      } else {
        elements.audio.bgMusic.pause();
        localStorage.setItem("music", "off");
      }
    }

    function toggleSFX() {
      if (elements.toggles.sfx.checked) {
        localStorage.setItem("sfx", "on");
      } else {
        localStorage.setItem("sfx", "off");
      }
    }

    function playSound(sound) {
      if (elements.toggles.sfx.checked && sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Sound error:", e));
      }
    }

    function playClick() {
      playSound(elements.audio.click);
    }

    function playCorrectSound() {
      playSound(elements.audio.correct);
    }

    function playWrongSound() {
      playSound(elements.audio.wrong);
    }

    function playLevelCompleteSound() {
      playSound(elements.audio.levelComplete);
    }

    function playHintSound() {
      playSound(elements.audio.hint);
    }

    function playSolutionSound() {
      playSound(elements.audio.solution);
    }

    function playScreenTransitionSound() {
      playSound(elements.audio.screenTransition);
    }

    function showScreen(id) {
      playScreenTransitionSound();
      history.pushState({screen: id}, "", "#"+id);
      Object.values(elements.screens).forEach(s => s.classList.remove("active"));
      elements.screens[id.replace("Screen", "")].classList.add("active");
      playClick();
    }

    function startGame() {
      loadLevel(currentLevel);
    }

    function renderLevels() {
      const grid = elements.gameElements.levelButtons;
      grid.innerHTML = "";
      riddles.forEach((_, i) => {
        const btn = document.createElement("button");
        btn.textContent = i + 1;
        btn.disabled = !solved.includes(i + 1) && (i + 1 !== currentLevel);
        
        if (solved.includes(i + 1)) {
          btn.classList.add("completed");
        }
        
        btn.addEventListener("click", () => loadLevel(i + 1));
        grid.appendChild(btn);
      });
    }

    function loadLevel(level) {
      clearConfetti();
      const r = riddles[level - 1];
      currentLevel = level;
      userAnswer = "";
      elements.gameElements.levelTitle.textContent = `Level ${level}`;
      elements.gameElements.questionText.textContent = r.question;
      elements.gameElements.answerBox.textContent = "";
      elements.gameElements.resultMsg.textContent = "";
      elements.gameElements.resultMsg.className = "result";
      showScreen("riddleScreen");
    }

    function press(n) {
      playClick();
      userAnswer += n;
      elements.gameElements.answerBox.textContent = userAnswer;
      elements.gameElements.resultMsg.textContent = "";
    }

    function clearAnswer() {
      playClick();
      userAnswer = "";
      elements.gameElements.answerBox.textContent = "";
      elements.gameElements.resultMsg.textContent = "";
    }

    function submitAnswer() {
      const r = riddles[currentLevel - 1];
      const msg = elements.gameElements.resultMsg;
      
      if (userAnswer === r.answer) {
        msg.textContent = "🎉 Correct!";
        msg.className = "result";
        playCorrectSound();
        
        fireConfetti(() => {
          if (!solved.includes(currentLevel)) {
            solved.push(currentLevel);
            localStorage.setItem("solvedLevels", JSON.stringify(solved));
          }
          currentLevel++;
          localStorage.setItem("currentLevel", currentLevel);
          playLevelCompleteSound();
          setTimeout(() => {
            if (currentLevel <= riddles.length) loadLevel(currentLevel);
            else {
              alert("🎊 All levels completed!");
              showScreen('homeScreen');
            }
          }, 1000);
        });
      } else {
        msg.textContent = "❌ Try again";
        msg.className = "result error";
        playWrongSound();
        setTimeout(() => {
          elements.gameElements.resultMsg.textContent = "";
          elements.gameElements.resultMsg.className = "result";
        }, 1500);
      }
    }

    function showHint() {
      playHintSound();
      const r = riddles[currentLevel - 1];
      alert(`💡 Hint: ${r.hint}\n\n(Current answer: ${userAnswer || "none"})`);
    }

    function showSolution() {
      playSolutionSound();
      const r = riddles[currentLevel - 1];
      alert(`🔍 Solution: ${r.solution}\n\nThe correct answer is: ${r.answer}`);
    }

    function fireConfetti(callback) {
      const canvas = elements.confettiCanvas;
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const particles = [];
      const colors = ['#7C4DFF', '#00E676', '#FF5252', '#FFD600', '#00B0FF'];
      
      // Create particles
      for (let i = 0; i < 80; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          size: Math.random() * 8 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          speed: Math.random() * 3 + 2,
          angle: Math.random() * Math.PI * 2,
          rotation: Math.random() * 360,
          rotationSpeed: Math.random() * 10 - 5
        });
      }
      
      let frame = 0;
      const anim = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(p => {
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          
          // Draw particle
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
          
          ctx.restore();
          
          // Update position
          p.y += p.speed;
          p.rotation += p.rotationSpeed;
          
          // Reset particles that fall off screen
          if (p.y > canvas.height + p.size) {
            p.y = -p.size;
            p.x = Math.random() * canvas.width;
          }
        });
        
        frame++;
        if (frame < 100) {
          requestAnimationFrame(anim);
        } else {
          clearConfetti();
          if (callback) callback();
        }
      };
      
      anim();
    }

    function clearConfetti() {
      const ctx = elements.confettiCanvas.getContext("2d");
      ctx.clearRect(0, 0, elements.confettiCanvas.width, elements.confettiCanvas.height);
    }

    // Initialize the game when DOM is loaded
    document.addEventListener("DOMContentLoaded", initGame);
  </script>
</body>
</html>
