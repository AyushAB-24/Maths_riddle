<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Math Riddles Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0a0a0a" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root {
      --accent: #00e6e6;
      --bg-dark: #0a0a0a;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      --key-size: min(20vw, 80px);
    }

    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: var(--font);
      background: var(--bg-dark);
      color: white;
      height: 100%;
      overflow: hidden;
      touch-action: manipulation;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: env(safe-area-inset-bottom, 8vh);
      opacity: 0;
      animation: fadeIn 1s ease-out forwards;
      animation-delay: 2.5s;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .screen {
      display: none;
      width: 100%;
      height: 100%;
      max-width: 500px;
      padding: 20px 15px;
      box-sizing: border-box;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .active {
      display: block;
    }

    h1 {
      font-size: clamp(32px, 8vw, 42px);
      color: var(--accent);
      text-align: center;
      margin-bottom: 5vh;
      text-shadow: 0 0 12px var(--accent);
    }

    h2 {
      font-size: clamp(24px, 6vw, 28px);
      color: var(--accent);
      text-align: center;
      margin-bottom: 15px;
    }

    .btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 14px;
      font-size: clamp(16px, 4vw, 18px);
      border-radius: 12px;
      margin: 8px auto;
      display: block;
      width: 90%;
      max-width: 300px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 230, 230, 0.3);
      transition: transform 0.1s ease, background 0.3s ease;
      touch-action: manipulation;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn:hover {
      background: #00bdbd;
      box-shadow: 0 4px 20px rgba(0, 230, 230, 0.5);
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 20px 0;
      padding: 0 10px;
    }

    .keypad button {
      height: var(--key-size);
      width: 100%;
      font-size: clamp(20px, 6vw, 24px);
      background: #00bcd4;
      color: white;
      border: none;
      border-radius: 10px;
      transition: transform 0.1s ease;
      touch-action: manipulation;
    }

    .keypad button:active {
      transform: scale(0.95);
    }

    .answer-box {
      font-size: clamp(22px, 7vw, 26px);
      color: #ffd54f;
      margin: 15px;
      min-height: 30px;
      text-align: center;
      word-break: break-all;
    }

    .result {
      font-size: clamp(16px, 4vw, 18px);
      margin-top: 10px;
      min-height: 25px;
      text-align: center;
    }

    .level-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 15px 0;
      padding: 0 10px;
    }

    .level-grid button {
      padding: 12px 0;
      border-radius: 8px;
      background-color: #333;
      color: #fff;
      border: 1px solid #444;
      font-size: clamp(12px, 3vw, 14px);
      transition: transform 0.1s ease;
    }

    .level-grid button:active {
      transform: scale(0.95);
    }

    .level-grid button:disabled {
      opacity: 0.3;
      cursor: default;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 25px 0;
      padding: 0 15px;
    }

    .toggle-container label {
      font-size: clamp(16px, 4vw, 18px);
    }

    input[type="checkbox"] {
      transform: scale(1.3);
    }

    canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 1000;
    }

    /* Splash Screen */
    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: var(--bg-dark);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 2000;
      animation: splashFade 2.5s ease-out forwards;
    }

    .logo {
      font-size: clamp(48px, 15vw, 64px);
      animation: logoAnim 2s ease-in-out infinite;
    }

    @keyframes logoAnim {
      0% { transform: scale(1) rotate(0); }
      30% { transform: scale(1.15) rotate(15deg); }
      60% { transform: scale(0.95) rotate(-10deg); }
      100% { transform: scale(1) rotate(0); }
    }

    @keyframes splashFade {
      0% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; visibility: hidden; }
    }

    /* Mobile-specific adjustments */
    @media (max-height: 600px) {
      h1 {
        margin-bottom: 3vh;
      }
      
      .btn {
        padding: 10px;
        margin: 6px auto;
      }
      
      .keypad {
        gap: 6px;
      }
      
      .keypad button {
        height: calc(var(--key-size) * 0.8);
      }
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash">
    <div class="logo">üß†</div>
    <div style="margin-top: 10px; font-size: clamp(18px, 5vw, 24px);">Math Riddles</div>
  </div>

  <!-- Main App Container -->
  <div class="container">
    <!-- Home Screen -->
    <div id="homeScreen" class="screen active">
      <h1>üß† Math Riddles</h1>
      <button class="btn" id="playBtn">‚ñ∂ Play</button>
      <button class="btn" id="levelsBtn">üìö Levels</button>
      <button class="btn" id="settingsBtn">‚öôÔ∏è Settings</button>
      <button class="btn" id="quitBtn">‚ùå Quit</button>
    </div>

    <!-- Settings Screen -->
    <div id="settingsScreen" class="screen">
      <h2>Settings</h2>
      <div class="toggle-container">
        <label for="musicToggle">üéµ Background Music</label>
        <input type="checkbox" id="musicToggle">
      </div>
      <button class="btn" id="backFromSettingsBtn">‚¨Ö Back</button>
    </div>

    <!-- Levels Screen -->
    <div id="levelsScreen" class="screen">
      <h2>Select Level</h2>
      <div class="level-grid" id="levelButtons"></div>
      <button class="btn" id="backFromLevelsBtn">‚¨Ö Back</button>
    </div>

    <!-- Riddle Screen -->
    <div id="riddleScreen" class="screen">
      <h2 id="levelTitle">Level</h2>
      <div id="questionText" style="text-align: center; padding: 0 10px;"></div>
      <div class="answer-box" id="answerBox"></div>

      <div class="keypad">
        <button data-number="1">1</button>
        <button data-number="2">2</button>
        <button data-number="3">3</button>
        <button data-number="4">4</button>
        <button data-number="5">5</button>
        <button data-number="6">6</button>
        <button data-number="7">7</button>
        <button data-number="8">8</button>
        <button data-number="9">9</button>
        <button id="clearBtn">C</button>
        <button data-number="0">0</button>
        <button id="submitBtn">‚úì</button>
      </div>

      <div class="result" id="resultMsg"></div>

      <button class="btn" id="hintBtn">Hint</button>
      <button class="btn" id="solutionBtn">Solution</button>
      <button class="btn" id="backFromGameBtn">‚¨Ö Back</button>
    </div>
  </div>

  <canvas id="confetti-canvas"></canvas>
  <audio id="bgMusic" src="bg-music.mp3" loop></audio>
  <audio id="clickSound" src="click.mp3"></audio>
  <audio id="correctSound" src="correct.mp3"></audio>
  <audio id="wrongSound" src="wrong.mp3"></audio>

  <script>
    // Game data
    const riddles = [
      { question: "I am 2-digit. Reversed I am 27 more. Digits add to 9. What am I?", answer: "36", hint: "Reverse: 63", solution: "63 - 36 = 27" },
      { question: "Divide 30 by half and add 10.", answer: "70", hint: "Divide by 0.5", solution: "30 √∑ 0.5 + 10 = 70" },
      { question: "Smallest 3-digit Armstrong number?", answer: "153", hint: "1¬≥+5¬≥+3¬≥", solution: "1+125+27=153" },
      { question: "If 1=3, 2=3, 3=5, 4=4, 5=4, then 6=?", answer: "3", hint: "Count letters in number words", solution: "six has 3 letters" },
      { question: "What comes next: 1, 11, 21, 1211, 111221, ...?", answer: "312211", hint: "Say the previous number", solution: "1, one 1, two 1s, one 2 one 1, etc." }
    ];
    
    // Generate additional riddles if needed
    while (riddles.length < 50) {
      let n = riddles.length + 1;
      const operations = [
        { op: '+', fn: (a,b) => a + b },
        { op: '-', fn: (a,b) => a - b },
        { op: '√ó', fn: (a,b) => a * b }
      ];
      const selected = operations[Math.floor(Math.random() * operations.length)];
      const a = Math.floor(Math.random() * 10) + 1;
      const b = Math.floor(Math.random() * 10) + 1;
      riddles.push({
        question: `What is ${a} ${selected.op} ${b}?`,
        answer: selected.fn(a,b).toString(),
        hint: `Basic arithmetic operation`,
        solution: `${a} ${selected.op} ${b} = ${selected.fn(a,b)}`
      });
    }

    // Game state
    let currentLevel = parseInt(localStorage.getItem("currentLevel") || "1");
    let solved = JSON.parse(localStorage.getItem("solvedLevels") || "[]");
    let userAnswer = "";
    let isProcessingInput = false; // Flag to prevent double input

    // DOM elements
    const elements = {
      screens: {
        home: document.getElementById("homeScreen"),
        settings: document.getElementById("settingsScreen"),
        levels: document.getElementById("levelsScreen"),
        riddle: document.getElementById("riddleScreen")
      },
      buttons: {
        play: document.getElementById("playBtn"),
        levels: document.getElementById("levelsBtn"),
        settings: document.getElementById("settingsBtn"),
        quit: document.getElementById("quitBtn"),
        backFromSettings: document.getElementById("backFromSettingsBtn"),
        backFromLevels: document.getElementById("backFromLevelsBtn"),
        backFromGame: document.getElementById("backFromGameBtn"),
        clear: document.getElementById("clearBtn"),
        submit: document.getElementById("submitBtn"),
        hint: document.getElementById("hintBtn"),
        solution: document.getElementById("solutionBtn")
      },
      gameElements: {
        levelTitle: document.getElementById("levelTitle"),
        questionText: document.getElementById("questionText"),
        answerBox: document.getElementById("answerBox"),
        resultMsg: document.getElementById("resultMsg"),
        levelButtons: document.getElementById("levelButtons")
      },
      audio: {
        bgMusic: document.getElementById("bgMusic"),
        click: document.getElementById("clickSound"),
        correct: document.getElementById("correctSound"),
        wrong: document.getElementById("wrongSound")
      },
      musicToggle: document.getElementById("musicToggle"),
      splash: document.getElementById("splash"),
      confettiCanvas: document.getElementById("confetti-canvas")
    };

    // Initialize the game
    function initGame() {
      // Set audio volumes
      elements.audio.bgMusic.volume = 0.3;
      elements.audio.click.volume = 0.6;
      elements.audio.correct.volume = 0.5;
      elements.audio.wrong.volume = 0.5;

      // Set up event listeners
      setupEventListeners();
      
      // Initialize music toggle
      if (localStorage.getItem("music") !== "off") {
        elements.musicToggle.checked = true;
        try {
          elements.audio.bgMusic.play().catch(e => {
            // Audio will be enabled after user interaction
          });
        } catch (e) {
          console.error("Audio error:", e);
        }
      } else {
        elements.musicToggle.checked = false;
        elements.audio.bgMusic.pause();
      }

      // Render levels
      renderLevels();

      // Handle splash screen
      setTimeout(() => {
        elements.splash.style.display = "none";
      }, 2500);
    }

    // Set up all event listeners
    function setupEventListeners() {
      // Navigation buttons
      elements.buttons.play.addEventListener("click", startGame);
      elements.buttons.levels.addEventListener("click", () => showScreen("levelsScreen"));
      elements.buttons.settings.addEventListener("click", () => showScreen("settingsScreen"));
      elements.buttons.quit.addEventListener("click", () => window.close());
      elements.buttons.backFromSettings.addEventListener("click", () => showScreen("homeScreen"));
      elements.buttons.backFromLevels.addEventListener("click", () => showScreen("homeScreen"));
      elements.buttons.backFromGame.addEventListener("click", () => showScreen("homeScreen"));
      
      // Game buttons
      elements.buttons.clear.addEventListener("click", clearAnswer);
      elements.buttons.submit.addEventListener("click", submitAnswer);
      elements.buttons.hint.addEventListener("click", showHint);
      elements.buttons.solution.addEventListener("click", showSolution);
      
      // Keypad buttons - using event delegation to prevent double input
      document.querySelector(".keypad").addEventListener("click", (e) => {
        if (isProcessingInput) return;
        isProcessingInput = true;
        
        const button = e.target.closest("button");
        if (button && button.dataset.number) {
          press(parseInt(button.dataset.number));
        }
        
        setTimeout(() => { isProcessingInput = false; }, 100);
      });
      
      // Touch events for keypad - using event delegation
      document.querySelector(".keypad").addEventListener("touchstart", (e) => {
        if (isProcessingInput) return;
        isProcessingInput = true;
        
        const button = e.target.closest("button");
        if (button) {
          if (button.dataset.number) {
            press(parseInt(button.dataset.number));
          }
          button.classList.add("active");
        }
        
        setTimeout(() => { isProcessingInput = false; }, 100);
      }, { passive: true });
      
      document.querySelector(".keypad").addEventListener("touchend", (e) => {
        const button = e.target.closest("button");
        if (button) {
          button.classList.remove("active");
        }
      }, { passive: true });
      
      // Music toggle
      elements.musicToggle.addEventListener("change", toggleMusic);
      
      // Handle Android back button
      window.addEventListener("popstate", handleBackButton);
      
      // Enable audio on first interaction
      const enableAudio = () => {
        document.removeEventListener("click", enableAudio);
        document.removeEventListener("touchstart", enableAudio);
        try {
          elements.audio.bgMusic.play().catch(e => console.log("Audio play error:", e));
        } catch (e) {
          console.error("Audio error:", e);
        }
      };
      document.addEventListener("click", enableAudio, { once: true });
      document.addEventListener("touchstart", enableAudio, { once: true });
    }

    function handleBackButton() {
      if (elements.screens.home.classList.contains("active")) {
        if (confirm("Do you want to exit the game?")) {
          window.close();
        }
      } else {
        showScreen("homeScreen");
      }
    }

    function toggleMusic() {
      if (elements.musicToggle.checked) {
        elements.audio.bgMusic.play().catch(e => console.log("Music play error:", e));
        localStorage.setItem("music", "on");
      } else {
        elements.audio.bgMusic.pause();
        localStorage.setItem("music", "off");
      }
    }

    function playClick() { 
      elements.audio.click.currentTime = 0;
      elements.audio.click.play().catch(e => console.log("Click sound error:", e));
    }

    function playCorrectSound() {
      elements.audio.correct.currentTime = 0;
      elements.audio.correct.play().catch(e => console.log("Correct sound error:", e));
    }

    function playWrongSound() {
      elements.audio.wrong.currentTime = 0;
      elements.audio.wrong.play().catch(e => console.log("Wrong sound error:", e));
    }

    function showScreen(id) {
      history.pushState({screen: id}, "", "#"+id);
      Object.values(elements.screens).forEach(s => s.classList.remove("active"));
      elements.screens[id.replace("Screen", "")].classList.add("active");
      playClick();
    }

    function startGame() {
      loadLevel(currentLevel);
    }

    function renderLevels() {
      const grid = elements.gameElements.levelButtons;
      grid.innerHTML = "";
      riddles.forEach((_, i) => {
        const btn = document.createElement("button");
        btn.textContent = solved.includes(i + 1) ? `‚úÖ ${i + 1}` : `üîí ${i + 1}`;
        btn.disabled = !solved.includes(i + 1) && (i + 1 !== currentLevel);
        btn.addEventListener("click", () => loadLevel(i + 1));
        grid.appendChild(btn);
      });
    }

    function loadLevel(level) {
      clearConfetti();
      const r = riddles[level - 1];
      currentLevel = level;
      userAnswer = "";
      elements.gameElements.levelTitle.textContent = `Level ${level}`;
      elements.gameElements.questionText.textContent = r.question;
      elements.gameElements.answerBox.textContent = "";
      elements.gameElements.resultMsg.textContent = "";
      showScreen("riddleScreen");
    }

    function press(n) {
      playClick();
      userAnswer += n;
      elements.gameElements.answerBox.textContent = userAnswer;
      elements.gameElements.resultMsg.textContent = "";
    }

    function clearAnswer() {
      playClick();
      userAnswer = "";
      elements.gameElements.answerBox.textContent = "";
      elements.gameElements.resultMsg.textContent = "";
    }

    function submitAnswer() {
      const r = riddles[currentLevel - 1];
      const msg = elements.gameElements.resultMsg;
      
      if (userAnswer === r.answer) {
        msg.textContent = "üéâ Correct!";
        msg.style.color = "#00e676";
        playCorrectSound();
        
        fireConfetti(() => {
          if (!solved.includes(currentLevel)) {
            solved.push(currentLevel);
            localStorage.setItem("solvedLevels", JSON.stringify(solved));
          }
          currentLevel++;
          localStorage.setItem("currentLevel", currentLevel);
          setTimeout(() => {
            if (currentLevel <= riddles.length) loadLevel(currentLevel);
            else {
              alert("üéä All levels completed!");
              showScreen('homeScreen');
            }
          }, 1000);
        });
      } else {
        msg.textContent = "‚ùå Wrong! Try again";
        msg.style.color = "#e53935";
        playWrongSound();
        setTimeout(clearAnswer, 800);
      }
    }

    function showHint() {
      playClick();
      alert("Hint: " + riddles[currentLevel - 1].hint);
    }

    function showSolution() {
      playClick();
      alert("Solution: " + riddles[currentLevel - 1].solution);
    }

    function fireConfetti(callback) {
      const canvas = elements.confettiCanvas;
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const pieces = Array.from({ length: 60 }, () => ({
        x: Math.random() * canvas.width,
        y: -10,
        size: Math.random() * 8 + 4,
        color: `hsl(${Math.random() * 360}, 100%, 50%)`,
        speed: Math.random() * 3 + 2,
        rotation: Math.random() * 360,
        rotationSpeed: Math.random() * 10 - 5
      }));
      
      let frame = 0;
      const anim = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pieces.forEach(p => {
          ctx.save();
          ctx.translate(p.x + p.size/2, p.y + p.size/2);
          ctx.rotate(p.rotation * Math.PI/180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
          ctx.restore();
          
          p.y += p.speed;
          p.rotation += p.rotationSpeed;
        });
        frame++;
        if (frame < 50) requestAnimationFrame(anim);
        else {
          clearConfetti();
          if (callback) callback();
        }
      };
      anim();
    }

    function clearConfetti() {
      const ctx = elements.confettiCanvas.getContext("2d");
      ctx.clearRect(0, 0, elements.confettiCanvas.width, elements.confettiCanvas.height);
    }

    // Initialize the game when DOM is loaded
    document.addEventListener("DOMContentLoaded", initGame);
  </script>
</body>
</html>
